## State Transition Master Table

This is the comprehensive reference for all state transitions in the system, consolidating implementation status, entity updates, triggers, and business rules.

| Step | Transition | Input Data Type | Trigger | Caller | User Session | Mission | Hop | Tool Step | Asset | Business Rules |
|------|------------|-----------------|---------|---------|-------------|---------|-----|-----------|-------|:---------------|
| **1.1** | PROPOSE_MISSION | `MissionLite` | Agent completes mission planning | `mission_specialist_node` in primary_agent.py | Links mission to active session | Creates with `status=AWAITING_APPROVAL` | No changes | No changes | Creates mission-scoped assets from mission_lite.assets data | Mission created in approval state, automatically linked to user's active session |
| **1.2** | ACCEPT_MISSION | `mission_id: str` | User clicks "Approve Mission" button | `acceptMissionProposal()` → stateTransitionApi.acceptMission() | No changes | Updates `status=IN_PROGRESS`, `updated_at=now()` | No changes | No changes | No changes | Mission approved by user, ready for hop planning |
| **2.1** | START_HOP_PLAN | `mission_id: str` | User requests hop planning via chat | User message → `hop_designer_node` | No changes | Sets `current_hop_id=hop_id`, `updated_at=now()` | Creates with `status=HOP_PLAN_STARTED` | No changes | No changes | User initiates hop planning. Hop created in started state. Agent begins planning |
| **2.2** | PROPOSE_HOP_PLAN | `HopLite` | Agent completes hop design | `hop_designer_node` → stateTransitionApi.proposeHopPlan() | No changes | No changes | **Updates hop with completed plan details (description, goal, rationale, success_criteria), sets `status=HOP_PLAN_PROPOSED`, `updated_at=now()`, stores intended_input_asset_ids and intended_output_asset_ids** | No changes | **Creates new mission output assets at MISSION scope (from intended_output_asset_specs), adds to mission asset mapping. No hop-scoped assets created** | Agent completes design and proposes to user. New mission output assets created for hop deliverables. Hop tracks intended inputs/outputs via asset IDs |
| **2.3** | ACCEPT_HOP_PLAN | `hop_id: str` | User clicks "Accept Hop Plan" button | `acceptHopProposal()` → stateTransitionApi.acceptHopPlan() | No changes | No changes | Updates `status=HOP_PLAN_READY`, `updated_at=now()` | No changes | No changes | User approves hop plan. Ready for implementation |
| **2.4** | START_HOP_IMPL | `hop_id: str` | User requests implementation via chat | User message → `hop_implementer_node` | No changes | No changes | Updates `status=HOP_IMPL_STARTED`, `updated_at=now()` | No changes | No changes | User initiates implementation. Agent begins creating tool steps |
| **2.5** | PROPOSE_HOP_IMPL | `List[ToolStepLite]` | Agent completes implementation design | `hop_implementer_node` → stateTransitionApi.proposeHopImpl() | No changes | No changes | Updates `status=HOP_IMPL_PROPOSED`, `updated_at=now()` | **Creates tool steps with `status=PROPOSED`, serializes parameter_mapping and result_mapping** | No changes | Agent proposes executable tool steps with serialized mappings. Implementation ready for approval |
| **2.6** | ACCEPT_HOP_IMPL | `hop_id: str` | User clicks "Accept Implementation" button | `acceptHopImplementationProposal()` → stateTransitionApi.acceptHopImplementation() | No changes | No changes | Updates `status=HOP_IMPL_READY`, `updated_at=now()` | **Updates all steps from PROPOSED to READY_TO_EXECUTE, sets updated_at=now()** | No changes | User approves implementation. All tool steps ready for execution |
| **2.7** | EXECUTE_HOP | `hop_id: str` | User clicks "Start Execution" button | `startHopExecution()` → stateTransitionApi.executeHop() | No changes | No changes | Updates `status=EXECUTING`, `updated_at=now()` | **Updates first step to EXECUTING, sets started_at=now() and updated_at=now()** | No changes | Hop execution begins. First tool step starts executing |
| **2.8** | COMPLETE_TOOL_STEP | `execution_result: Dict` | Tool execution completes (or simulated) | Tool engine → stateTransitionApi.completeToolStep() | No changes | No changes | No changes | **Updates step to COMPLETED, sets execution_result, completed_at=now(), started_at=now() if not set** | **Creates hop-scoped output assets based on result_mapping and execution outputs** | Individual tool step completion with output asset creation. Simulated execution supported for testing |
| **2.9** | COMPLETE_HOP | `hop_id: str` | All tool steps completed | System detection → stateTransitionApi.completeHop() | No changes | **If final hop**: `status=COMPLETED`, `updated_at=now()`<br>**If non-final hop**: `current_hop_id=null`, `updated_at=now()` | Updates `status=COMPLETED`, `is_resolved=true`, `updated_at=now()`, adds execution_result to hop_metadata | No changes | **Promotes hop output assets to mission scope with promotion metadata** | **Hop completion triggers asset promotion. Final hop completes entire mission** |
| **2.10** | COMPLETE_MISSION | `mission_id: str` | Manual mission completion | Direct API call → stateTransitionApi.completeMission() | No changes | Updates `status=COMPLETED`, `updated_at=now()` | No changes | No changes | No changes | Manual mission completion endpoint for exceptional cases |
